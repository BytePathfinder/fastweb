# 权限管理改进方案实际落地方案

## 一、项目现状分析

### 1.1 当前架构概览
基于项目结构分析，当前fastweb项目采用多模块Maven架构：
```
fastweb/
├── app/                    # 应用启动模块
├── biz/                    # 业务模块
│   ├── auth/              # 认证业务
│   └── user/              # 用户业务
├── core/                  # 核心模块
│   ├── common/            # 通用组件
│   ├── infra/             # 基础设施
│   │   └── infra-security/ # 安全基础设施
│   └── starter/           # 自动配置启动器
│       └── security-starter/ # 安全启动器
```

### 1.2 现有安全架构
- **JWT认证**: JwtAuthenticationFilter + JwtUtils
- **动态权限**: DynamicAuthorizationManager + DynamicSecurityMetadataSource
- **按钮权限**: ButtonPermissionChecker + ButtonPermissionAspect
- **用户保护**: UserProtectionService + UserProtectionAspect

## 二、分阶段落地实施方案

### 阶段1：表达式权限引擎 (2周)

#### 1.1 核心表达式引擎实现

<write_to_file>
<path>core/infra/infra-security/src/main/java/com/company/fastweb/core/infra/security/expression/PermissionExpressionEngine.java</path>
<content>
package com.company.fastweb.core.infra.security.expression;

import lombok.extern.slf4j.Slf4j;
import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;
import org.springframework.expression.spel.support.StandardEvaluationContext;
import org.springframework.stereotype.Component;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * 权限表达式引擎
 * 支持SpEL表达式的权限动态判断
 */
@Slf4j
@Component
public class PermissionExpressionEngine {
    
    private final ExpressionParser parser = new SpelExpressionParser();
    private final Map<String, Expression> expressionCache = new ConcurrentHashMap<>();
    
    /**
     * 评估权限表达式
     * @param expression 权限表达式
     * @param context 上下文变量
     * @return 权限判断结果
     */
    public boolean evaluate(String expression, Map<String, Object> context) {
        try {
            Expression expr = expressionCache.computeIfAbsent(expression, 
                key -> parser.parseExpression(key));
            
            StandardEvaluationContext evalContext = new StandardEvaluationContext();
            context.forEach(evalContext::setVariable);
            
            Boolean result = expr.getValue(evalContext, Boolean.class);
            return Boolean.TRUE.equals(result);
        } catch (Exception e) {
            log.error("权限表达式评估失败: {}, 上下文: {}", expression, context, e);
            return false;
        }
    }
    
    /**
     * 验证表达式语法
     * @param expression 权限表达式
     * @return 是否有效
     */
    public boolean validateExpression(String expression) {
        try {
            parser.parseExpression(expression);
            return true;
        } catch (Exception e) {
            log.warn("权限表达式语法错误: {}", expression, e);
            return false;
        }
    }
    
    /**
     * 清理表达式缓存
     */
    public void clearCache() {
        expressionCache.clear();
    }
}