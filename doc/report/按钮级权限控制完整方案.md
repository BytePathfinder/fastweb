# 按钮级权限控制完整方案

## 概述

基于RuoYi-Plus等优秀开源框架的设计理念，我们已经实现了完整的按钮级权限控制后台支持系统。

## 1. 数据库设计

### 1.1 核心表结构

参考RuoYi-Plus框架，我们设计了完整的权限管理表结构：

#### 用户相关表
- `sys_user` - 用户信息表
- `sys_dept` - 部门表  
- `sys_post` - 岗位信息表
- `sys_user_post` - 用户与岗位关联表

#### 权限相关表
- `sys_role` - 角色信息表
- `sys_menu` - 菜单权限表（支持菜单、按钮、接口三种类型）
- `sys_user_role` - 用户和角色关联表
- `sys_role_menu` - 角色和菜单关联表
- `sys_role_dept` - 角色和部门关联表

#### 系统配置表
- `sys_config` - 参数配置表
- `sys_dict_type` - 字典类型表
- `sys_dict_data` - 字典数据表
- `sys_notice` - 通知公告表

#### 日志审计表
- `sys_oper_log` - 操作日志记录
- `sys_logininfor` - 系统访问记录
- `sys_user_online` - 在线用户记录

#### 任务调度表
- `sys_job` - 定时任务调度表
- `sys_job_log` - 定时任务调度日志表

#### 代码生成表
- `gen_table` - 代码生成业务表
- `gen_table_column` - 代码生成业务表字段

### 1.2 按钮权限设计

在 `sys_menu` 表中，通过 `menu_type` 字段区分权限类型：
- `M` - 目录
- `C` - 菜单
- `F` - 按钮

按钮权限示例：
```sql
-- 用户管理按钮权限
INSERT INTO sys_menu VALUES('1001', '用户查询', '100', '1', '', '', '', 1, 0, 'F', '0', '0', 'system:user:query', '#', 'admin', sysdate(), '', null, '');
INSERT INTO sys_menu VALUES('1002', '用户新增', '100', '2', '', '', '', 1, 0, 'F', '0', '0', 'system:user:add', '#', 'admin', sysdate(), '', null, '');
INSERT INTO sys_menu VALUES('1003', '用户修改', '100', '3', '', '', '', 1, 0, 'F', '0', '0', 'system:user:edit', '#', 'admin', sysdate(), '', null, '');
```

## 2. 后端实现

### 2.1 按钮权限检查器

`ButtonPermissionChecker` 类提供了完整的按钮权限检查功能：

```java
@Component
public class ButtonPermissionChecker {
    
    // 检查当前用户是否拥有指定按钮权限
    public boolean hasButtonPermission(String buttonPermission);
    
    // 检查用户是否拥有多个按钮权限中的任意一个
    public boolean hasAnyButtonPermission(String... buttonPermissions);
    
    // 检查用户是否拥有所有指定的按钮权限
    public boolean hasAllButtonPermissions(String... buttonPermissions);
    
    // 获取当前用户的所有按钮权限
    public Set<String> getCurrentUserButtonPermissions();
    
    // 刷新用户按钮权限缓存
    public void refreshUserButtonPermissions(String username);
}
```

### 2.2 按钮权限注解

`@ButtonPermission` 注解用于方法级权限控制：

```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface ButtonPermission {
    String[] value();                    // 按钮权限编码
    boolean requireAll() default false;  // 是否需要拥有所有权限
    String description() default "";     // 权限描述
}
```

### 2.3 按钮权限切面

`ButtonPermissionAspect` 切面拦截带有 `@ButtonPermission` 注解的方法：

```java
@Aspect
@Component
public class ButtonPermissionAspect {
    
    @Around("@annotation(buttonPermission)")
    public Object checkButtonPermission(ProceedingJoinPoint joinPoint, ButtonPermission buttonPermission) throws Throwable {
        // 权限检查逻辑
    }
}
```

### 2.4 按钮权限控制器

`ButtonPermissionController` 提供按钮权限查询和管理的API接口：

```java
@RestController
@RequestMapping("/api/button-permissions")
public class ButtonPermissionController {
    
    // 获取当前用户的所有按钮权限
    @GetMapping("/current")
    public ResponseEntity<Map<String, Object>> getCurrentUserButtonPermissions();
    
    // 检查当前用户是否拥有指定按钮权限
    @GetMapping("/check/{permission}")
    public ResponseEntity<Map<String, Object>> checkButtonPermission(@PathVariable String permission);
    
    // 批量检查按钮权限
    @PostMapping("/check-batch")
    public ResponseEntity<Map<String, Object>> checkButtonPermissions(@RequestBody String[] permissions);
}
```

## 3. 使用示例

### 3.1 注解方式

```java
@RestController
@RequestMapping("/api/demo/button-permissions")
public class ButtonPermissionDemoController {

    // 用户管理 - 新增用户按钮
    @PostMapping("/user/add")
    @ButtonPermission("system:user:add")
    public ResponseEntity<Map<String, Object>> addUser(@RequestBody Map<String, Object> userData) {
        // 业务逻辑
    }

    // 用户管理 - 删除用户按钮（需要多个权限）
    @DeleteMapping("/user/{id}/delete")
    @ButtonPermission(value = {"system:user:remove", "system:user:delete"}, requireAll = true)
    public ResponseEntity<Map<String, Object>> deleteUser(@PathVariable Long id) {
        // 业务逻辑
    }
}
```

### 3.2 编程方式

```java
@Service
public class UserService {
    
    @Autowired
    private ButtonPermissionChecker buttonPermissionChecker;
    
    public void updateUser(User user) {
        // 检查是否有编辑权限
        if (!buttonPermissionChecker.hasButtonPermission("system:user:edit")) {
            throw new AccessDeniedException("权限不足，无法编辑用户");
        }
        
        // 业务逻辑
    }
}
```

### 3.3 前端集成

```javascript
// 获取当前用户按钮权限
async function getCurrentUserPermissions() {
    const response = await fetch('/api/button-permissions/current');
    const data = await response.json();
    return data.buttonPermissions;
}

// 检查按钮权限
async function hasButtonPermission(permission) {
    const response = await fetch(`/api/button-permissions/check/${permission}`);
    const data = await response.json();
    return data.hasPermission;
}

// 批量检查权限
async function checkButtonPermissions(permissions) {
    const response = await fetch('/api/button-permissions/check-batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(permissions)
    });
    const data = await response.json();
    return data.permissionResults;
}
```

## 4. 权限编码规范

### 4.1 命名规范

按钮权限编码采用层级结构：`模块:功能:操作`

示例：
- `system:user:add` - 系统管理-用户管理-新增
- `system:user:edit` - 系统管理-用户管理-编辑
- `system:user:delete` - 系统管理-用户管理-删除
- `system:role:assign` - 系统管理-角色管理-分配权限

### 4.2 常用操作类型

- `query` - 查询
- `add` - 新增
- `edit` - 编辑
- `remove` - 删除
- `export` - 导出
- `import` - 导入
- `reset` - 重置
- `assign` - 分配

## 5. 缓存策略

### 5.1 Redis缓存

用户按钮权限存储在Redis中，键名格式：`fastweb:user:button:permissions:{username}`

### 5.2 缓存刷新

- 用户权限变更时自动刷新缓存
- 提供手动刷新接口
- 支持批量刷新

## 6. 安全特性

### 6.1 超级管理员保护

- 超级管理员自动拥有所有按钮权限
- 无需在数据库中显式配置

### 6.2 权限继承

- 支持角色权限继承
- 支持用户直接权限分配
- 权限合并策略

### 6.3 审计日志

- 记录权限检查日志
- 记录权限变更日志
- 支持权限使用统计

## 7. 性能优化

### 7.1 缓存优化

- Redis缓存减少数据库查询
- 权限信息预加载
- 缓存过期策略

### 7.2 批量操作

- 支持批量权限检查
- 减少网络请求次数
- 提高前端渲染性能

## 8. 扩展性

### 8.1 自定义权限类型

- 支持扩展新的权限类型
- 灵活的权限编码规则
- 可配置的权限策略

### 8.2 多租户支持

- 支持租户级权限隔离
- 租户权限模板
- 权限数据分离

## 9. 总结

我们已经实现了完整的按钮级权限控制系统，具备以下特点：

### ✅ 完整性
- 完整的数据库设计
- 完整的后端实现
- 完整的API接口
- 完整的使用示例

### ✅ 易用性
- 注解方式简单易用
- 编程方式灵活强大
- 前端集成方便
- 权限编码规范清晰

### ✅ 性能
- Redis缓存提升性能
- 批量操作减少请求
- 权限预加载优化

### ✅ 安全性
- 超级管理员保护
- 权限继承机制
- 审计日志记录

### ✅ 扩展性
- 支持自定义权限类型
- 支持多租户
- 灵活的配置策略

**按钮级权限控制系统已经完全就绪，可以满足企业级应用的各种权限控制需求！**